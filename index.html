<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Stock Eats</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç¥</text></svg>">

<style>

*{box-sizing:border-box;margin:0;padding:0}

body{
font-family:-apple-system,BlinkMacSystemFont,Arial;
background:#000;
color:white;
height:100vh;
overflow:hidden;
}

header{
padding:10px;
text-align:center;
font-size:20px;
font-weight:600;
}

#search{
display:flex;
gap:8px;
padding:8px;
}

input{
flex:1;
padding:14px;
border-radius:12px;
border:none;
font-size:16px;
}

button{
padding:14px;
border:none;
border-radius:12px;
background:#ff6f00;
color:white;
font-size:16px;
}

#gps{
background:#444;
}

#map{
height:45vh;
width:100%;
}

#results{
height:20vh;
overflow:auto;
padding:6px;
backdrop-filter:blur(12px);
}

#rated{
position:fixed;
bottom:0;
left:0;
right:0;
background:rgba(30,30,30,.9);
backdrop-filter:blur(15px);
border-radius:18px 18px 0 0;
max-height:32vh;
overflow:auto;
padding:10px;
touch-action:none;
}

.handle{
width:40px;
height:4px;
background:#555;
border-radius:3px;
margin:6px auto;
}

.card{
padding:12px;
border-bottom:1px solid #333;
font-size:16px;
}

.savedCard{
display:flex;
justify-content:space-between;
align-items:center;
padding:14px;
border-bottom:1px solid #333;
font-size:16px;
}

.remove{color:red;font-size:20px}

#drawer{
position:fixed;
bottom:-320px;
left:0;
right:0;
background:rgba(30,30,30,.95);
backdrop-filter:blur(18px);
padding:14px;
border-radius:18px 18px 0 0;
transition:.25s;
z-index:9999
}

.star{font-size:34px;color:#444}
.star.active{color:gold}

#stars{margin:10px 0}

#save{
width:100%;
font-size:18px;
}

</style>
</head>

<body>

<header>üç¥ Stock Eats</header>

<div id="search">
<input id="q" placeholder="Restaurant or address">
<button id="gps">üìç</button>
<button id="go">Go</button>
</div>

<div id="map"></div>

<div id="results"></div>

<div id="rated">
<div class="handle"></div>
</div>

<div id="drawer">
<div id="dname"></div>
<div id="daddr" style="font-size:12px;opacity:.7;margin-bottom:6px"></div>

<div id="stars">
<span class="star" data="1">‚òÖ</span>
<span class="star" data="2">‚òÖ</span>
<span class="star" data="3">‚òÖ</span>
<span class="star" data="4">‚òÖ</span>
<span class="star" data="5">‚òÖ</span>
</div>

<button id="save">Save Rating</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

const map=L.map('map').setView([51.5,-0.12],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let current=null;
let currentRating=0;
let markers=[];
let savedMarkers=[];
let rated=JSON.parse(localStorage.getItem("rated"))||[];

const results=document.getElementById("results");
const ratedBox=document.getElementById("rated");
const drawer=document.getElementById("drawer");

function openDrawer(r){
current=r;
currentRating=r.score||0;
document.getElementById("dname").innerText=r.name;
document.getElementById("daddr").innerText=r.address;
updateStars();
drawer.style.bottom="0";
}

document.querySelectorAll(".star").forEach(s=>{
s.onclick=()=>{
currentRating=parseInt(s.dataset.data||s.getAttribute("data"));
updateStars();
};
});

function updateStars(){
document.querySelectorAll(".star").forEach(x=>{
x.classList.toggle("active",parseInt(x.getAttribute("data"))<=currentRating)
});
}

document.getElementById("save").onclick=()=>{
if(!current||!currentRating)return;

const e=rated.find(x=>x.name===current.name);
if(e)e.score=currentRating;
else rated.push({...current,score:currentRating});

localStorage.setItem("rated",JSON.stringify(rated));
drawer.style.bottom="-320px";
renderRated();
};

function renderRated(){
rated.sort((a,b)=>b.score-a.score);
ratedBox.innerHTML='<div class="handle"></div>';
savedMarkers.forEach(m=>map.removeLayer(m));
savedMarkers=[];

rated.forEach((r,i)=>{
const d=document.createElement("div");
d.className="savedCard";
d.innerHTML=`<span>${r.name} ${"‚òÖ".repeat(r.score)}</span><span class="remove">‚úï</span>`;

d.querySelector(".remove").onclick=e=>{
e.stopPropagation();
rated.splice(i,1);
localStorage.setItem("rated",JSON.stringify(rated));
renderRated();
};

d.onclick=()=>{
map.setView([r.lat,r.lng],17);
L.popup().setLatLng([r.lat,r.lng]).setContent(`<b>${r.name}</b><br>${r.address}<br>${"‚òÖ".repeat(r.score)}`).openOn(map);
};

ratedBox.appendChild(d);

const m=L.marker([r.lat,r.lng],{icon:L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",iconSize:[32,32]})}).addTo(map);
savedMarkers.push(m);
});
}

async function search(){
markers.forEach(m=>map.removeLayer(m));
markers=[];
results.innerHTML="";

const q=document.getElementById("q").value.trim();
if(!q)return;

const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=6&countrycodes=gb`);
const data=await res.json();

data.forEach(p=>{
const lat=+p.lat,lng=+p.lon;
const name=p.display_name.split(",")[0];
const obj={name,address:p.display_name,lat,lng};

const m=L.marker([lat,lng],{icon:L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png",iconSize:[32,32]})}).addTo(map);
markers.push(m);
m.on("click",()=>openDrawer(obj));

const c=document.createElement("div");
c.className="card";
c.innerHTML=`<b>${name}</b><small>${p.display_name}</small>`;
c.onclick=()=>{map.setView([lat,lng],17);openDrawer(obj)};
results.appendChild(c);
});
}

document.getElementById("go").onclick=search;
document.getElementById("q").addEventListener("keydown",e=>{if(e.key==="Enter")search()});

document.getElementById("gps").onclick=()=>{
navigator.geolocation.getCurrentPosition(pos=>{
map.setView([pos.coords.latitude,pos.coords.longitude],15);
});
};

let startY=0;
ratedBox.addEventListener("touchstart",e=>startY=e.touches[0].clientY);
ratedBox.addEventListener("touchmove",e=>{
const d=e.touches[0].clientY-startY;
ratedBox.style.bottom=Math.min(0,d)+"px";
});

renderRated();

</script>

</body>
</html>
